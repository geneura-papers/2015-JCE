%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  ejemplo.tex %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% Fichero de ejemplo LaTeX que ilustra el uso de la Hoja de Estilo %%%%%%
%%%%% Jornadas.cls para Jornadas Sarteco.              %%%%%%

\documentclass[twocolumn,twoside]{Jornadas}
\usepackage[latin1]{inputenc}
\usepackage{graphicx}
\usepackage{url}

\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}

\newtheorem{theorem}{Teorema}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\hyphenation{}

\begin{document}


\title{Arquitectura de bajo coste para monitorización de vehículos y personas usando Bluetooth y WiFi}

\author{%
     P. García-Sánchez, A. Fernández-Ares, P. A. Castillo, M. I. García Arenas,  P. de las Cuevas, A. M. Mora, G. Romero, J. J. Merelo %
     \thanks{Dpto. de Arquitectura y Tecnología de Computadores, Universidad de Granada, e-mail: {\tt {pablogarcia,antares,pacv,mgarenas,amorag,jmerelo}@ugr.es}}
     P. García-Fernández%
     \thanks{Departamento de Electrónica y Tecnología de  Computadores, Universidad de Granada, e-mail: {\tt pfernan@ditec.ugr.es }}
}

\maketitle
% Oculta las cabeceras y los n\'umeros de p\'agina.
% Ambos elemetos se a\~nadir\'an durante la edici\'on de las actas completas.
\markboth{}{}
\pagestyle{empty} 
\thispagestyle{empty} % Oculta el n\'umero de la primera p\'agina

\begin{abstract}
Actualmente existen distintos sistemas de monitorización de vehículos y personas, como las espiras o cámaras de detección de matrículas. Sin embargo, estos sistemas pueden resultar excesivamente caros y difíciles de mantener y desplegar. Además, muchos de estos sistemas no permiten una idenfiticación univoca de un mismo vehículo o persona, o de hacerlo, supone una violación de la intimidad. Es por ello necesario considerar un sistema de bajo coste que permita la monitorización de los desplazamientos con un procesamiento cercano al tiempo real con el fin de proporcionar a los ciudadanos información para la toma de decisiones en el ámbito de la movilidad. Este paper describe el entorno hardware y software de un sistema de bajo coste para la monitorización y procesamiento de datos de vehículos y personas mediante la detección de las comunicaciones Bluetooth y Wifi (de forma anónima) de sus dispositivos inteligentes. 
\end{abstract}

\begin{keywords}
Bluetooth, Predicción del Tráfico, Monitorización, WiFi, Movilidad, SmartCities
\end{keywords}

\section{Introducci\'on}


\PARstart{L}{a}  mayoría de los sistemas empleados para monitorizar el flujo
de tráfico en las carreteras resultan excesivamente caros para
una implantación en masa, y además solo recogen información
sobre la cuantía de vehículos que han circulado. Además, muchas de esas
tecnologías son incapaces de identificar el mismo vehículo en
diferentes sitios u ocurrencias sobre el mismo dispositivo
capturador, limitándose tan solo a contar y obtener algún tipo
de información vaga sobre el tipo de vehículo \cite{traffic13,martin2003detector}.
Los sistemas que si son capaces de reconocer vehículos, hacen uso de sistemas basados en cámaras
y reconocimiento OCR de las matrículas, lo cual puede entrar en conflicto con las leyes de privacidad
y derecho a la intimidad vigentes.
Además, estos sistemas se limitan al control de vehículos sobre vías principales de tráfico,
dejando de lado tanto la problemática del control de los desplazamientos en vías secundarias o urbanos,
tanto en vehículos principales, como empleando transportes compartidos o desplazamientos a pie.
Contar con un sistema de información sobre el movimiento no sólo de vehículos si no de personas y proveer mecanismos
de predición de dichos movimientos se antoja clave en el contexto actual convergente a las SmartCities.
Con más de un 90\% de la población que posee y utiliza cada vez más dispositivos de comunicación ubicuos, tales
como teléfonos móviles, obtener información sobre la situación y movimiento de dicha población basándose en la
detección de los dispositivos inteligentes que portan encima significaría poder gestionar de manera optima las
principales redes de desplazamiento. Tal sistema ayudaría a las políticas urbanísticas y de ordenación territorial
a redicir la necesidad de desplazamientos y los tiempos de los mismos, al poder ser planificados por los ciudadanos
partiendo de información veraz y actual sobre el estado de las vías, así como sus tasas de ocupación, las rutas
preferentes o detección de anomalías en la circulación.
%Aquí quedo cambiando el texto para que hable de movilidad en general. Voy a lo que sólo yo puedo escribir
La aplicación de esta propuesta en el transporte supondría disponer
de un sistema de información sobre el estado del trafico
y de predicción del uso de la red viaria por parte de las personas.
También ayudaría a gestionar de manera óptima una red de
comunicaciones vital para un procentaje elevado de usuarios.
La primera consecuencia directa sería un aprovechamiento más
eficiente del uso de los vehículos en los desplazamientos, por lo
que se podría esperar un menor número de trayectos en vehículo
privado, o al menos más optimizados.
Estos objetivos son los que nos hemos planteado en el presente
desarrollo, y pasan por contar con un sistema de información y
de predicción de tráfico para que puedan ser utilizados con el
fin de reducir los desplazamientos individuales, así como incrementar
los desplazamientos en transporte público.
Nuestro objetivo final es disponer de información acerca de los
flujos de tráfico que se producen entre ciudades, lo que permitirá
poder gestionar de manera óptima las decisiones de desplazamiento
por parte de los ciudadanos.
La idea es obtener un sistema de ayuda a la toma de decisiones,
capaz de aplicar conocimiento en aplicaciones comerciales
relacionadas con la movilidad.

Para ello, el procesamiento de los datos adquiridos con estos
sistemas requiere de algoritmos complejos de minería de datos,
computación evolutiva y redes neuronales, aprendizaje automático
 y de métodos estadísticos, que se irán desarrollando e integrando
como servicios web en el sistema.

Por tanto, encontramos que se tienen varias necesidades desde
el punto de vista de la gestión del transporte:
\begin{itemize}
\item Se necesitará un dispositivo autónomo y versátil de recogida
de datos y monitorización.
\item Además es necesario recopilar los datos del tráfico en tiempo
real.
\item Una vez se tienen los datos, hay que procesarlos de manera
correcta para poder ofrecer la información específica necesaria.
\item También se necesita un sistema que teniendo en cuenta la
evolución de los actuales sistemas de información, permita
poder compartir esos datos con aquellos que toman decisiones
sobre movilidad, no sólo desde el punto de vista
institucional sino también desde el punto de vista personal.
\item Por último, y máxime en el contexto actual, se necesita un
sistema de información que sea de bajo coste, que permita
su amortización de la manera más rápida posible y que
posibilite que sea capitalizado por parte de todo tipo de
agentes en la ciudad.
\end{itemize}

Todas estas necesidades se han tenido en cuenta para desarrollar la arquitectura presentada en este artículo, basada en nodos de captación de dispositivos Bluetooth y Wifi. Una versión anterior de la misma fue presentada en \cite{Castillo13Indicadores}, donde distintos datos de monitorización fueron recolectados y mostrados. Sin embargo,
ese trabajo no mostraba de forma clara una descripción clara del sistema a desarrollar, salvo una breve descripción del mismo. El presente trabajo lo complementa, describiendo el sistema a nivel hardware y software en profundidad, permitiendo a nuevos investigadores usarlo como base para futuras experimentaciones, además de mostrar las nuevas funcionalidades añadidas.

El resto del artículo se estructura como sigue: tras el Estado del Arte (Sección \ref{sec:soa}), la parte hardware y software del sistema es descrita en la Sección \ref{sec:descripcion}. Los resultados de un prototipo experimental se comentan en la Sección \ref{sec:prototipo} y finalmente se presentan las conclusiones y trabajo futuro. 

\section{Estado del arte}
\label{sec:soa}
Otros trabajos han utilizado routers WiFi para posicionaminto. Por ejemplo, en \cite{Rivadeneyra10Wifi} se utiliza la intensidad de hotspots wifi en un dispositivo móvil para localización en interiores, usando una base de datos de intensidades y posiciones como base. Sin embargo, es el dispositivo móvil el que permite conocer la localización de la persona, lo que obliga a instalar una aplicación para detectar usuarios. Además, cambios en la infraestructura de los hotspots implicaría volver a recalcular la base de datos de intensidades.

En \cite{Castillo13Indicadores} se presentó una versión preliminar del sistema descrito en este trabajo. En ese trabajo se mostraron unos prototipos de monitorización basados en arquiectura microPC, junto con algunos datos de monitorización. Sin embargo, ese trabajo no explicaba el proceso de captación de datos ni describía la arquitectura software y hardware del sistema (que además, estaba en un versión anterior a la presentada aquí). El presente trabajo, por lo tanto, permitirá a nuevos investigadores desarrollar su propio sistema de monitorización teniendo en cuenta las decisiones de diseño tomadas para esta nueva versión. 

\section{Descripción del sistema}
\label{sec:descripcion}

El sistema se describe en este artículo tanto por su elementos hardware (el dispositivo físico de captación y servidores) como por los elementos software que nutren el sistema (software de captación, procesamiento, predición y difusión). Así no puede entenderse el sistema como un elemento aislado y atómico, sino como un entramado de elementos tanto hardware como software comunicánose entre ellos como se observa en la figura \ref{fig:sistema}. 

\begin{figure*}[ht] 
\begin{center} 
\includegraphics[scale=0.35]{imags/DiagramaSoftware.pdf}
%\epsfig{file=imags/DiagramaSoftware.eps,width=7cm}
\end{center} 
\caption{Descripción del sistema.} 
\label{fig:sistema} 
\end{figure*}


\subsubsection{Dispositivos de monitorización}

El dispositivo de monitorización está basado en Raspberry Pi, en concreto el sistema funcional presentado
en este artículo hace uso de Raspberry Pi Model A (Figura \ref{fig:raspberry}), aunque se está actualizando el sistema operativo y software para hacerlo funcionar sobre Raspberry Pi 2 Model B, pues su mayor capacidad de cómputo paralelo puede suponer una optimización significativa del funcionamiento del dispositivo de captación. Sin embargo, el cambio de arquitectura sufrido entre los modelos, hace que sea necesario un estudio concienzudo de la migración.

Además de la Raspberry Pi que hace de centro de procesamiento, son necesarios otros elementos hardware:
%\begin{itemize}
%\item Tarjeta de red Wifi
%\item Tarjeta de red Bluetooth
%\item Antenas de captación
%\item Caja protectora estanca certificada.
%\end{itemize}

La elección de la tarjeta de red no es trivial, pues ha de cumplir varios requisitos. Es necesario que sea compatible
con el sistema operativo elegido, que sea capaz de operar en modo monitor lo que permita la captura promiscua de paquetes (conocido como sniffering). Además según el emplazamiento del dispositivo, puede ser requerida una antena con características especiales (omnidireccional o direccional, mayor o menor ganancia, integrada en el dispositivo o alejada varios metros) por lo que disponer de un sistema estándar de antena es un requerimiento añadido. La tarjeta elegida es una \textit{TP-Link TL-WN722N} que dispone de interfaz USB de conexión y conexión RP-SMA para la antena.

La tarjeta bluetooth elegida es una \textit{Conceptronic CBT40 NANO} debido a ser de las más comunes en el mercado compatibles con Bluetooth 4.0 y ser de Clase 1. Su interfaz de conexión es USB, pero lamentablemente la antena se haya integrada dentro del chipset por lo que no es posible de forma estándar cambiarla.

La caja estánca empleada cumple las certificaciones IP67 de protección frente a polvo y humedad y Clase II de aislamiento eléctrico. 

\begin{figure*}[htb] 
\centering
\includegraphics[width=10cm]{imags/raspi.pdf}
%\epsfig{file=images/sindicador.eps,width=12cm}

\caption{Raspberry Pi utilizada en los dispositivos de monitorización.} 
\label{fig:raspberry} 
\end{figure*}

\subsection{HOREB: Sistema Operativo}
Las Raspberry Pi Model A empleadas hace uso de un procesador ARM6 \footnote{En las nuevas Raspberry Pi 2, el procesador es cambiado por un ARM7 lo que permite elegir una mayor cantidad de Sistemas Operativos compatibles con la arquitectura} por lo cual es necesario instalar un sistema operativo que sea compatible con la arquitectura del procesador. En este caso el Sistema Operativo elegido es Raspbian, distribución basada en Debian enfocada en la compatibilidad con Raspberry Pi. Hace uso de la versión 3.10.24+ del kernel de Linux y nos permite disponer de un sistema Linux completo en un sistema de placa única como es Raspberry.

Las ventajas de emplear un sistema operativo completo son numerosas: administración remota, sistema de logs y cron nativos, repositorios de sofware,...

Sin embargo es necesario realizar algunas modificaciones al SO para optimizarlo al problema de captación que nos ocupamos. El almacenamiento sólido de las Raspberry Pi está basado en tarjetas SD (o microSD en Model B y adelante). Sin bien las velocidades alcanzables por tarjetas Clase 10 es más que suficiente para correr un sistema operativo, existe un problema documentado de corrupción de las tarjetas SD ante fallos eléctricos tales como perdida de alimentación o subidas de tensión.

Siendo dispositivos como los presentados en este artículo que van a ser ubicados en zonas de complicado acceso frecuente, tener un sistema operativo tan vulnerable a fallos (corrupciones) supone un problema.

Es por ello que se ha modificado el sistema operativo de modo que funcione como un Sistema Operativo de Solo Lectura. De esta forma, se minimizan las escrituras en el medio y se garantiza que en todos los arranques del dispositivo va a disponer de una versión estable no corrupta de los archivos necesarios para su inicio.

Sin embargo, un sistema operativo Linux requiere de numerosos directorios donde poder escribir para el funcionamiento del mismo. Esto se resuelve con particiones \texttit{tmpfs} montado en memoria volátil. Esto aporta numerosas ventajas, ya que al ser mucho más rápida la memoria volátil que la solida las operaciones son generalmente mucho más rápidas. Sin embargo, al ser memoria volátil, los datos no persisten después de los reinicios del sistema. Además, al estar alojada en la memoria RAM de la Raspberry Pi, se pierde capacidad máxima de propósito general. Se sacrifica por tanto al almacenamiento a lo largo del tiempo y parte de la memoria RAM con el fin de conseguir un sistema operativo más tolerable a fallos, corrupciones de datos y eficiencia en general.

\subsection{Descripción del software}

El software que soporta el sistema, está formado por varios módulos independientes, que se relacionan entre ellos según la figura \ref{fig:sistema}. 

\begin{figure*}[ht] 
\begin{center} 
\includegraphics[scale=0.35]{imags/DiagramaSoftware.pdf}
%\epsfig{file=imags/DiagramaSoftware.eps,width=7cm}
\end{center} 
\caption{Descripción del sistema.} 
\label{fig:sistema} 
\end{figure*}

Como se puede apreciar en el sistema, existen cinco partes bien diferenciadas a las que hemos etiquetado con un nombre, Raziel, Lilith, Abdiel, Ezequiel y Anan que se relacionan entre ellas unidireccionalmente según el flujo de los datos. En el dispositivo se ejecutan Raziel y Lilith implementados en Java y en PHP respectivamente y ambas corren sobre el sistema operativo Horeb. Ambas partes de forma independiente envían datos a Abdiel, también implemenado en PHP, que es el único que tiene acceso a la base de datos Alejandría gestionada por MySQL. De las consultas a la base de datos Alejandría se ocupa Ezequiel, también implementado en PHP. Tanto Ezequiel, como Abdiel se ejecutan de forma simultánea en el servidor donde está almacenada la base de datos. Este servidor tiene un sistema operativo Linux. Por último Anan  .....

% Antares amplía aquí un poco sobre Anan, lenguaje y relación con las demás partes, la función o la descripción de lo que hace, está en el itemize del siguiente párrafo.

En el párrafo anterior hemos descrito un la relación entre las partes y los diferentes sistemas operativos y lenguajes que hemos utilizado. A continuación detallaremos un poco la función de cada una de las partes, intentando no entrar en muchos detalles, puesto que no disponemos del suficiente espacio.
\begin{itemize}
\item Raziel: La función de Raziel es la captación de dispositivos. Esta captación se hace escaneando el entorno donde está situado y captando paquetes BT o Wifi que emiten los dispositivos cuando intentan descubrir otros dispositivos BT o un punto de acceso Wifi a los que conectarse. Los pasos que sigue Raziel a grandes rasgos son:
 \begin{enumerate}
 \item Comprobación de que la conexión a red para conectar con Abdiel está disponible, ya sea de forma inalámbrica o alámbrica.
 \item Inicializa la hebra de captación BT que se ejecutará durante todo el tiempo que Raziel esté ejecutándose. Esta hebra se encarga de detectar nuevos dispositivos BT, monitorizarlos registrando durante cuanto tiempo son detectados y notificar dicha información a Abdiel cada cierto tiempo.
 \item ... Voy por aquí.
 \end{enumerate}

\item Lilith
\item Abdiel
\item Ezequiel
\item Anan % Esto es lo que quiero que haga Antares. 
\end{itemize}



\section{Prototipo experimental}
\label{sec:prototipo}


\section{Conclusiones y trabajo futuro}
\label{sec:conclusiones}

Actualmente existen distintas necesidades desde el punto de vista de gestión del transporte, como la necesidad de dispositivos de captación de datos y monitorización, de bajo coste, autónomos y que permitan la detección univoca de los usuarios para poder realizar decisiones sobre la gestión de la movilidad. Este trabajo describe un sistema hardware y software basado en nodos de captación de los dispositivos Bluetooth y WiFi de los agentes a medir, permitiendo su identificación de forma univoca y anónima. Los elementos software y hardware han sido descritos, junto con los datos de un prototipo funcional.

Como trabajo futuro se está planteando utilizar el modelo más avanzado de Raspberry Pi (modelo 2), que permitirá añadir nuevos dispositivos de captación (GSM, luminosidad, temperatura, etc.). Además, distintos algoritmos de predicción, y combinación con otras fuentes de datos serán añadidos al servidor de procesamiento.


\section*{Agradecimientos}
Este artículo ha sido financiado en parte por los proyectos
TIN2014-56494-C4-3-P (EphemeCH),
SIPESCA (Programa Operativo FEDER de Andalucía 2007-2013),
SPIP2014-01437 (Dirección General de Tráfico), 
PRY142/14 (Fundación Pública Andaluza Centro de Estudios Andaluces en la IX Convocatoria de Proyectos de Investigación) y PYR-2014-17 GENIL project (CEI-BIOTIC Granada).


\bibliographystyle{Jornadas}
\bibliography{monitorizacion-jce}

\end{document}
