%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  ejemplo.tex %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% Fichero de ejemplo LaTeX que ilustra el uso de la Hoja de Estilo %%%%%%
%%%%% Jornadas.cls para Jornadas Sarteco.              %%%%%%

\documentclass[twocolumn,twoside]{Jornadas}
\usepackage[latin1]{inputenc}
\usepackage{graphicx}
\usepackage{url}
\usepackage{listings}

\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}

\newtheorem{theorem}{Teorema}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\hyphenation{}

\begin{document}


\title{Arquitectura de bajo coste para monitorización de vehículos y personas usando Bluetooth y WiFi}

\author{%
     P. García-Sánchez, A. Fernández-Ares, P. A. Castillo, M. I. García Arenas,  P. de las Cuevas, G. Romero, J. J. Merelo, J. González\thanks{Dpto. de Arquitectura y Tecnología de Computadores, Universidad de Granada, e-mail: {\tt {pablogarcia, antares, pacv, mgarenas, paloma, gustavo, jmerelo, jesusgonzalez}@ugr.es}},
     A. M. Mora%
     \thanks{Departamento de Teoría de la Señal, Telemática y Comunicaciones, Universidad de Granada, e-mail: {\tt amorag@ugr.es }},
     P. García-Fernández%
     \thanks{Departamento de Electrónica y Tecnología de  Computadores, Universidad de Granada, e-mail: {\tt pfernan@ditec.ugr.es }}
}

\maketitle
% Oculta las cabeceras y los n\'umeros de p\'agina.
% Ambos elemetos se a\~nadir\'an durante la edici\'on de las actas completas.
\markboth{}{}
\pagestyle{empty} 
\thispagestyle{empty} % Oculta el n\'umero de la primera p\'agina

\begin{abstract}
Actualmente existen distintos sistemas de monitorización de tráfico de vehículos y movilidad de personas, como las espiras 
% Antonio - hay un nombre más 'tecnico' para las espiras'? FERGU: que yo sepa no xD
o las cámaras de detección de matrículas. Sin embargo, estos sistemas pueden resultar excesivamente caros y difíciles de mantener y desplegar. Además, muchos de ellos no permiten una identificación unívoca de un mismo vehículo o persona, o, de hacerlo, esto podría suponer una violación de la privacidad de dicha persona. Es por ello necesario considerar un sistema de bajo coste que permita la monitorización de los desplazamientos, con un procesamiento cercano al tiempo real 
% Antonio - porcesamiento de qué? no se ha justificado por qué hace falta que sea en tiempo real. ;)
con el fin de proporcionar a los ciudadanos información para la toma de decisiones en el ámbito de la movilidad. Este artículo describe el entorno hardware y software de un sistema de bajo coste para la monitorización y procesamiento de datos de vehículos y personas detectados mediante mecanismos que supervisan las comunicaciones Bluetooth y Wifi (de forma anónima) de sus dispositivos móviles. 
% Antonio - esto queda muy cool, pero yo no lo pondría así. Yo pondría 'dispositivos móviles' o 'portables'
\end{abstract}

\begin{keywords}
Monitorización, Predicción del Tráfico, Bluetooth, WiFi, Movilidad, Smart Cities
\end{keywords}

\section{Introducci\'on}


\PARstart{L}{a}  mayoría de los sistemas empleados para monitorizar el flujo
de tráfico en las carreteras resultan excesivamente caros para
una implantación en masa, y además solo recogen información
sobre la cuantía de vehículos que han circulado. Muchas de esas
tecnologías son incapaces de identificar el mismo vehículo en
diferentes sitios u ocurrencias sobre el mismo dispositivo
capturado, limitándose tan solo a contar y obtener algún tipo
de información limitada sobre el tipo de vehículo 
% Antonio - eso de 'vaga' no lo diria yo... FERGU: pongo limitada
\cite{traffic13,martin2003detector}.
Los sistemas que sí son capaces de reconocer vehículos, hacen uso de tecnologías basadas en cámaras de vídeo y reconocimiento óptico de caracteres (OCR) de las matrículas, lo cual puede entrar en conflicto con las leyes de privacidad
y derecho a la intimidad vigentes.
Además, estos sistemas se limitan al control de vehículos sobre vías principales de tráfico,
dejando de lado, por ejemplo, la problemática del control de los desplazamientos en vías secundarias o urbanos,
tanto en vehículos principales, como empleando transportes compartidos (públicos) o desplazamientos a pie.

Contar con un sistema de información sobre el movimiento no sólo de vehículos sino de personas y proveer mecanismos de predicción de dichos movimientos se antoja clave en el contexto actual convergente a las \textit{Smart Cities}.
Con un alto porcentaje de la población que posee y utiliza cada vez más dispositivos de comunicación ubicuos, tales
como teléfonos móviles, obtener información sobre la situación y movimiento de dichos individuos basándose en la
detección de estos dispositivos inteligentes 
% Antonio - lo de inteligentes nunca me ha gustado...yo lo quitaría
que portan encima significaría poder gestionar de manera óptima las
principales redes de desplazamiento. 
Dicho sistema ayudaría a las políticas urbanísticas y de ordenación territorial
a reducir la necesidad de desplazamientos y los tiempos de los mismos, al poder ser planificados por los ciudadanos
partiendo de información veraz y actual sobre el estado de las vías, así como sus tasas de ocupación, las rutas
preferentes o la detección de anomalías en la circulación.
%Aquí quedo cambiando el texto para que hable de movilidad en general. Voy a lo que sólo yo puedo escribir

La aplicación de esta propuesta en el transporte supondría disponer
de un sistema de información sobre el estado del trafico, así como de predicción del uso de la red viaria por parte de las personas.
También ayudaría a gestionar de manera óptima una red de
comunicaciones vital para un porcentaje elevado de usuarios.
La primera consecuencia directa sería un aprovechamiento más
eficiente del uso de los vehículos en los desplazamientos, por lo
que se podría esperar un menor número de trayectos en vehículo
privado, o, al menos, más optimizados.

Estos objetivos son los que nos hemos planteado en el presente
trabajo, 
los cuales pasan por contar con un sistema de información y
de predicción de tráfico para que puedan ser utilizados con el
fin de reducir los desplazamientos individuales, así como incrementar
los desplazamientos en transporte público, por ejemplo.
% Antonio - esto ya se ha dicho 3 veces...

Nuestro objetivo final es disponer de información acerca de los
flujos de tráfico que se producen entre ciudades, lo que permitirá
poder gestionar de manera óptima las decisiones de desplazamiento
por parte de los ciudadanos.
La idea es obtener un sistema de ayuda a la toma de decisiones,
capaz de aplicar conocimiento en aplicaciones comerciales
relacionadas con la movilidad.
% Antonio - se han dicho varias ideas, todas centradas en lo mismo.
% Yo lo rescribiría diciendo esto sólo una vez y poniendo cada caso como un ejemplo

Para ello, el procesamiento de los datos adquiridos con estos
sistemas requiere de algoritmos complejos de minería de datos,
computación evolutiva y redes neuronales, 
% Antonio - se mezclan cosas: primero, no hay por qué usar los AEs siempre por cojones (XD); segundo, los métodos de aprendizaje automático incluyen a las redes neuronales, por ejemplo. :D
aprendizaje automático
 así como de métodos estadísticos, que se irán desarrollando e integrando
como servicios web en el sistema.
% Antonio - esto habría que justificarlo un poco. ;)

Por tanto, 
% Antonio - el 'por tanto' no cuadra aquí.
encontramos que se tienen varias necesidades desde
el punto de vista de la gestión del transporte:
\begin{itemize}
\item Se necesitará un dispositivo autónomo y versátil de recogida
de datos y monitorización.
\item Además es necesario recopilar los datos del tráfico en tiempo
real.
\item Una vez se tienen los datos, hay que procesarlos de manera
correcta para poder ofrecer la información específica necesaria.
\item También se necesita un sistema que teniendo en cuenta la
evolución de los actuales sistemas de información, permita
poder compartir esos datos con aquellos que toman decisiones
sobre movilidad, no sólo desde el punto de vista
institucional sino también desde el punto de vista personal.
\item Por último, y máxime en el contexto financiero actual, se necesita un
sistema de información que sea de bajo coste, que permita
su amortización de la manera más rápida posible y que
posibilite que sea capitalizado por parte de todo tipo de
agentes en la ciudad.
% Antonio - esta frase  ('capitalizado...ciudad') queda muy formal, supongo que la habréis sacado de alguna reunión con jefazos de tráfico o algo... :D
\end{itemize}

Todas estas necesidades se han tenido en cuenta para desarrollar la arquitectura hardware y software presentada en este artículo, basada en nodos de captación de dispositivos Bluetooth y Wifi. En \cite{Castillo13Indicadores}, los autores presentaron la idea preliminar así como los resultados obtenidos a partir de unas pruebas preliminares. Este trabajo viene a completar el anterior, describiendo el sistema a nivel hardware y software en profundidad, permitiendo a nuevos investigadores usarlo como base para futuras experimentaciones, 
% Antonio - esto de los investigadores lo quitaría. :P
además de mostrar las nuevas funcionalidades añadidas.


% Antonio - hacer más hincapié en lo que se presenta aquí: la arquitectura detallada del sistema a nivel hardware y software, no lo del tráfico en sí. ;D

El resto del artículo se estructura como sigue: tras el Estado del Arte (Sección \ref{sec:soa}), la parte hardware y software del sistema es descrita en la Sección \ref{sec:descripcion}. Finalmente se presentan las conclusiones y trabajo futuro en la sección \ref{sec:conclusiones}. 

% *************************************************************************

\section{Estado del arte}
\label{sec:soa}


Hoy en día, existen varias tecnologías para la monitorización o recopilación de datos y la posterior extracción de información sobre el estado de las carreteras. Estos sistemas pueden clasificarse en función de la inmediatez de los datos, de lo completa que sea la cantidad de información obtenida, y del grado de invasión \cite{martin2003detector}.

Según la inmediatez con la que se obtienen los datos, los sistemas pueden clasificarse como de obtención directa (la fuente obtiene los datos de manera experimental), o indirecta (los datos son el resultado de un posterior procesado algorítmico).

Por otra parte, las tecnologías de monitorización actuales pueden considerarse invasivas, si éstas están instaladas en el pavimento de la carreteras, no invasivas cuando los sistemas no tienen contacto con la carretera y tienen mínimo o nulo efecto sobre el flujo de tráfico, o bien son tecnologías de monitorización a través de vehículos flotantes.

De forma que, los principales métodos de monitorización del tráfico se basan en el uso de tubos neumáticos, espiras magnéticas
% Antonio - espiras...¿magnéticas? Es que queda muy soso lo de espiras a secas. FERGU: done
o vehículos flotantes \cite{rodrigue2013geography}.  La principal desventaja de estos sistemas es que no son capaces de identificar de forma unívoca a los vehículos detectados, muy útil para trazar matrices origen/destino, por ejemplo. Además se centran sólo en la detección de vehículos, ignorando aspectos como el número de ocupantes por vehículo o los desplazamientos a pie.
% Antonio - bueno, nosotros con lo de los ocupantes también tenemos un problema. Habría que señalarlo al hablar del sistema. ;)

En los últimos años, las tecnologías que facilitan el reconocimiento automático de vehículos han mejorado ostensiblemente, siendo capaces de detectar vehículos de manera unívoca. Es el caso de la detección a través de las imágenes de vídeo, mediante OCR de las matriculas de los coches. Sin embargo, la Agencia de Protección de Datos española especifica que el uso de sistemas que obtengan datos de tipo personal (como serían dichas matrículas) requiere del consentimiento expreso por parte del usuario.


Además, estos sistemas son muy costosos tanto en implantación como en mantenimiento, por lo que su colocación en carreteras secundarias y vías urbanas resulta económicamente inviable, de modo que únicamente son empleados en carreteras primarias \cite{sherry2001report}.

El empleo de dispositivos de bajo coste como el propuesto, que monitoriza las señales Wifi y Bluetooth de dispositivos móviles, permite superar muchas de las limitaciones de los anteriores sistemas: 
% Antonio - no todas (por ejemplo lo de los ocupantes)
Se identifica de forma única a cada dispositivo pero sin vulnerar la ley de protección de datos, dado que no existe un registro 
% Antonio - si existe un registro. ;D
ni forma de vincular un dispositivo con su usuario o dueño; además, su bajo coste permite su despliegue en zonas consideradas como secundarias, que de otra manera no serían monitorizadas.

Existen sistemas que han utilizado routers WiFi para posicionamiento. Por ejemplo, en \cite{Rivadeneyra10Wifi} se utiliza la intensidad de hotspots WiFi en un dispositivo móvil para localización en interiores, usando una base de datos de intensidades y posiciones como base. 
% Antonio - 'base' => 'referencia'?
Sin embargo, es el dispositivo móvil el que permite conocer la localización de la persona, lo que obliga a instalar una aplicación para detectar usuarios. Además, cambios en la infraestructura de los hotspots implicaría volver a recalcular la base de datos de intensidades.
% Antonio - sería una base de datos o una tabla?

En \cite{GarciaFernandezMonitorizacion,Castillo14Individualized} se presentó una versión preliminar del sistema descrito en este trabajo. En ese capítulo se mostraron unos prototipos de monitorización basados en arquitectura \textit{microPC}, junto con algunos datos de monitorización de vehículos usando Bluetooth. Sin embargo, ese trabajo no explicaba el proceso de captación de datos ni describía la arquitectura software y hardware del sistema (que además, estaba en un versión anterior a la presentada aquí). Además, tampoco se utilizó para la detección de movilidad de personas considerando señales WiFi. El presente trabajo, por tanto, permitirá a nuevos investigadores desarrollar su propio sistema de monitorización teniendo en cuenta las decisiones de diseño tomadas para esta nueva versión. 
% Antonio - Yo lo diría como que en trabajo presenta más en detalle el sistema y las mejoras incluídas. Y dejaría a un lado lo de los investigadores, que no será el objetivo del mismo, ¿no? :D

% *************************************************************************

\section{Descripción del sistema}
\label{sec:descripcion}

El sistema se describe considerando tanto sus elementos hardware (el dispositivo físico de captación y servidores), como los elementos software que lo componen (software de captación, procesamiento, predicción y difusión). 
Este sistema no debe entenderse como un elemento aislado y atómico, sino como un entramado de componentes (hardware y software) comunicándose entre ellos como se observa en la figura \ref{fig:sistema}. 

\begin{figure*}[htb] 
\begin{center} 
\includegraphics[scale=0.35]{imags/DiagramaSoftware.eps}
%\epsfig{file=imags/DiagramaSoftware.eps,width=7cm}
\end{center} 
\caption{Descripción del sistema.} 
\label{fig:sistema} 
\end{figure*}

% -----------------------------------------------------------------------

\subsection{Descripción de los dispositivos de monitorización}

El dispositivo de monitorización está basado en \textit{Raspberry Pi}\footnote{\url{https://www.raspberrypi.org/}}, 
% Antonio - yo pondría una url en nota al pie a la web de Raspberri Pi
en concreto el sistema funcional presentado
en este artículo hace uso de Raspberry Pi Model A (Figura \ref{fig:raspberry}), aunque se está actualizando el sistema operativo y software para hacerlo funcionar sobre Raspberry Pi 2 Model B, pues su mayor capacidad de cómputo paralelo puede suponer una optimización significativa del funcionamiento del dispositivo de captación. Sin embargo, el cambio de arquitectura sufrido entre los modelos, hace que sea necesario un estudio concienzudo de la migración.

Además de la Raspberry Pi que hace de centro de procesamiento, son necesarios otros elementos hardware:
\begin{itemize}
\item Tarjeta de red Wifi
\item Tarjeta de red Bluetooth
\item Antenas de captación
\item Caja protectora estanca certificada.
\end{itemize}
% Antonio - cuidado que esto está comentado y habria que cambiar la frase de antes. ;)

La elección de la tarjeta de red no es trivial, pues ha de cumplir varios requisitos: Es necesario que sea compatible con el sistema operativo elegido, que sea capaz de operar en modo monitor, lo que permitirá la captura promiscua de paquetes (conocido como \textit{sniffering}). Además, según el emplazamiento del dispositivo, puede ser requerida una antena con características especiales (omnidireccional o direccional, con mayor o menor ganancia, integrada en el dispositivo o alejada varios metros) por lo que disponer de un sistema estándar de antena es un requerimiento añadido. La tarjeta elegida es una \textit{TP-Link TL-WN722N} 
% Antonio - link a la web de producto. ;)
que dispone de interfaz USB de conexión y conexión RP-SMA 
% Antonio - qué es RP-SMA?
para la antena.

La tarjeta Bluetooth elegida es una \textit{Conceptronic CBT40 NANO} 
% Antonio - link
ya que es una de las más comunes en el mercado compatibles con Bluetooth 4.0 y de Clase 1. 
% Antonio - qué significa de Clase 1?
Su interfaz de conexión es USB, pero lamentablemente la antena está integrada dentro del chipset por lo que no es posible cambiarla de forma estándar.
% Antonio - y eso afecta al sistema? decirlo si afecta o si no. ;D

La caja estanca empleada para albergar el dispositivo de monitorización cumple las certificaciones IP67 de protección frente a polvo y humedad y Clase II de aislamiento eléctrico. 
% Antonio - enlaces y/o explicaciones. ;)

\begin{figure*}[htb] 
\centering
\includegraphics[width=10cm]{imags/raspi.eps}
%\epsfig{file=images/sindicador.eps,width=12cm}

\caption{Raspberry Pi utilizada en los dispositivos de monitorización.} 
\label{fig:raspberry} 
\end{figure*}

% -------------------------------------------------------------------------

\subsection{Descripción de los elementos del sistema a nivel software}

Como se puede apreciar en la Figura \ref{fig:sistema}, existen cinco partes bien diferenciadas a las que hemos etiquetado con un nombre, \textit{Raziel, Lilith, Abdiel, Ezequiel} y \textit{Anan}, 
% Antonio - yo veo demasiados nombres, usaría uno sólo para el sistema y yastá. Pero bueno, si a Antares le gusta...
que se relacionan entre ellas unidireccionalmente según el flujo de los datos. En el dispositivo se ejecutan Raziel y Lilith, que están implementados en Java y en PHP respectivamente. Ambas se ejecutan sobre el sistema operativo, llamado Horeb en este sistema. 
% Antonio - ¿lo cualo? ¿qué S.O. es ese? FERGU: cambiado
Ambas partes envían datos a Abdiel de forma independiente. Éste también está  implementado en PHP, y es el único que tiene acceso a la base de datos Alejandría gestionada por MySQL. 
% Antonio - otros dos nombres... :_(
A continuación se describen estos elementos, junto con las consideraciones tomadas a la hora de diseñarlos.

\subsubsection{Horeb: Sistema Operativo}
% Antonio - por qué ese nombre?
Las Raspberry Pi Model A empleadas tienen un procesador ARM6 \footnote{En las nuevas Raspberry Pi 2, el procesador ha sido cambiado por un ARM7 lo que permite elegir una mayor cantidad de Sistemas Operativos compatibles con la arquitectura.} por lo cual es necesario instalar un sistema operativo que sea compatible con la arquitectura de dicho procesador. En este caso el Sistema Operativo elegido es Raspbian, distribución basada en Debian enfocada en la compatibilidad con Raspberry Pi. Hace uso de la versión 3.10.24+ del kernel de Linux y nos permite disponer de un entorno Linux completo en un sistema de placa única como es Raspberry.

Las ventajas de emplear un sistema operativo completo son numerosas: administración remota, sistema de logs y cron nativos, repositorios de software,etc.

Sin embargo es necesario realizar algunas modificaciones al SO para optimizarlo al problema de captación que nos ocupa: El almacenamiento físico de las Raspberry Pi está basado en tarjetas SD (microSD en Model B o superiores). Si bien las velocidades que alcanzan las tarjetas de Clase 10 es más que suficiente para que funcione un sistema operativo, existe un problema documentado de corrupción 
% Antonio - corrompimiento? No sé si corrupción aplica bien aquí. :/
de las tarjetas SD ante fallos eléctricos tales como perdida de alimentación o subidas de tensión.

Siendo dispositivos como los presentados en este artículo que van a ser ubicados en zonas de complicado acceso frecuente, tener un sistema operativo 
% Antonio - bueno, no es el SO, es el sistema de almacenamiento lo que es vulnerable, ¿no?
tan vulnerable a fallos (corrupciones) supone un problema.

Es por ello que se ha modificado el SO de modo que funcione como un Sistema Operativo de Solo Lectura. 
% Antonio - URL o explicación
De esta forma, se minimizan las escrituras en el medio y se garantiza que, en todos los arranques del dispositivo, se va a disponer de una versión estable no corrupta de los archivos necesarios para su inicio.

Sin embargo, un sistema operativo Linux requiere de numerosos directorios donde poder escribir para el correcto funcionamiento del mismo. Esto se resuelve con particiones \textit{tmpfs} montadas en memoria volátil. 
% Antonio - explicación de tmpfs...
Lo cual aporta numerosas ventajas, ya que, al ser mucho más rápida la memoria volátil que la física, las operaciones son generalmente mucho más rápidas. Sin embargo, al ser memoria volátil, los datos no persisten después de los reinicios del sistema. Además, al estar alojada en la memoria RAM de la Raspberry Pi, se pierde capacidad máxima de propósito general. 
% Antonio - 'capacidad máxima de propósito general'???
Se sacrifica por tanto al almacenamiento a lo largo del tiempo y parte de la memoria RAM con el fin de conseguir un sistema operativo más robusto ante fallos, corrupciones de datos y más eficiente en general. Las particiones de Horeb son mostradas en la Figura \ref{fig:horeb-particiones}.

Además, debido al uso intensivo del hardware USB (las tarjetas Wifi y Bluetooth), es necesario indicarle al SO que no puede suspender los dispositivos USB para ahorrar energía. Esta medida que en Sistemas Operativos de propósito general es muy útil y supone un ahorro en el consumo bastante significativo, en nuestro sistema supondría la perdida de captación de datos en los momentos en los que la tarjeta estuviese suspendida. Esto se consigue con la opción
% Antonio - haciendo quñe con la opción? Es decir, cambiándola de '1' a '-1' o qué?
 \textit{usbcore.autosuspend=-1} en el módulo USBCORE del kernel del SO.

\begin{figure*}[htb]
\begin{lstlisting}
pi@raspberrypi ~ $ df
Filesystem     1K-blocks    Used Available Use% Mounted on
rootfs           3125900 2658372    298808  90% /
/dev/root        3125900 2658372    298808  90% /
devtmpfs          215824       0    215824   0% /dev
tmpfs              44820     240     44580   1% /run
tmpfs               5120       0      5120   0% /run/lock
tmpfs              89620       0     89620   0% /run/shm
/dev/mmcblk0p1     57288   19072     38216  34% /boot
/dev/mmcblk0p3  11582963   39247  10941421   1% /usr/share/raziel
tmpfs              15360     100     15260   1% /tmp
tmpfs              15360    6516      8844  43% /var/log
\end{lstlisting}
\caption{Particiones del Sistema Horeb}
\label{fig:horeb-particiones}
\end{figure*}

Debido a que las Raspberry Pi no incorporan una pila para el reloj interno, es necesario solicitar la fecha y hora mediante un servidor NTP con el fin de garantizar la correcta sincronización todos los dispositivos de captación.

Se incorporan también las librerías necesarias para la ejecución del software, siendo destacadas las librerías JDK de Java, JSR para el Bluetooth, {\em aircraft} para la captura Wifi o {\em Sakis3G} para las comunicaciones mediante 3G.

Por último, es sistema operativo incorpora el Software \textit{Raziel} como servicio a ser ejecutado tras el arranque del sistema de forma automática.

% ---------------------------------------------------------

\subsubsection{Raziel: Software de Captación}

Raziel es el software integrado como demonio del sistema encargado de la detección de pasos de dispositivos (correspondientes a personas o vehículos) mediante la captura de paquetes Wifi y la localización de dispositivos Bluetooth cercanos. Estas capturas son procesadas enviadas a un servidor (Abdiel) periódicamente.

El software ha sido desarrollado en Java siguiendo un metodología de programación orientada a eventos y multihebrada. A pesar de que la Raspberry Pi Model A empleada en los prototipos descritos dispone de un único procesador, el software ha sido desarrollado teniendo en mente su posterior aplicación a arquitecturas con mayor cantidad de unidades de procesamiento, como la Raspberry Pi 2.

Se ha implementado de forma modular cada una de las funcionalidades del software de forma que operen de manera autónoma. Las distintas hebras y subsistemas se comunicarán por medio de memoria compartida.

Entre las tareas del software se encuentran funciones para el mantenimiento de sí mismo, ya que cabe la posibilidad de que el sistema no disponga de administración remota (dependiendo de la infraestructura de red donde sea colocado).
% Antonio - esto cómo se hace?
De modo que, por ejemplo, dependiendo de la red, el software es capaz de establecer mecanismos para la conexión con el exterior mediante Ethernet, Wifi o 3G. En el caso de la conexión Wifi, la misma tarjeta de red es empleada tanto para la captura de paquetes como para establecer dicha conexión. Esto es posible gracias a la virtualización de dos interfaces de red al mismo tiempo.

Cada sistema de captación (Bluetooth y Wifi) tiene un funcionamiento similar compuesto por cuatro elementos:
% Antonio - hay 4 elementos. XD FERGU: arreglao

\begin{itemize}
\item Hebra de control
\item Escaneador
\item Monitor
\item Difusor
\end{itemize}

La \textbf{hebra de control} es la encargada de iniciar las interfaces y comunicaciones con el dispositivo físico, así como estar a la escucha de las peticiones del sistema, como por ejemplo, para detenerse.

El \textbf{escaneador} es el encargado implementar el \textit{listener} que obedece al evento de captura de paquete \textit{wifiRaw} o la detección de dispositivos Bluetooth. Éste realiza la interpretación de los octetos conseguidos por la interfaz de red. 
% Antonio - aclarad lo de los octetos (la MAC o lo que sean)
Si el octeto es válido y es posible interpretarlo 
% Antonio - ¿por qué no sería posible interpretarlo?
se genera una ocurrencia de dispositivo que es enviado al monitor mediante memoria compartida. Esta ocurrencia de dispositivo incluye la hora en la que ha sido detectado, la intensidad de la señal (solo en Wifi) así como un hash de la MAC del dispositivo que ha realizado el envío, así como el fabricante, gracias a que los primeros 24 bits de la MAC son otorgados por el IEEE y pueden usarse para identificar univocamente al fabricante del dispositivo que genera la MAC. 
% Antonio - los da el IEEE? :D 
% Yo pondría algo como 'al seguir el estándar definido por el IEEE' FERGU: arreglado

En Wifi esta información se obtiene gracias al protocolo {\em radiotap}, que permite conseguir información de la propia tarjeta sobre el paquete capturado. De esta forma se consigue la intensidad de la señal con la que ha sido capturado el paquete y la cabecera 802.11 que incluye las MACs. En ningún momento, se procesa ni accede a los octetos capturados pertenecientes al cuerpo de la trama.

En Bluetooth, se obedece al evento de dispositivo visible, es decir, actualmente solo podemos detectar dispositivos que se encuentran visibles de forma pública. Sin embargo, gracias al protocolo Bluetooth podemos saber que tipo de dispositivo es el que hemos detectado gracias a los bits de tipo de dispositivo y servicios ofrecidos.

El \textbf{monitor} gestiona la cola de ocurrencias detectadas. Esta hebra es la encarga de determinar si un dispositivo es descubierto por primera vez o ya ha sido detectado anteriormente a lo largo del tiempo. Actualiza la lista de dispositivos detectados recientemente con la información de la ocurrencia del nuevo. De forma periódica comprueba dicha lista, buscando dispositivos que no hayan sido detectados transcurrido un tiempo prudencial. Los dispositivos que no han sido localizados en dicho periodo de tiempo, son empaquetados como pasos de dispositivos y enviados como memoria compartida al difusor. Un paso de dispositivo está compuesto por dos instantes de tiempo que indican la primera y última vez que se localizó al dispositivo, las intensidades de las señales en esas dos ocasiones y un hash de la MAC de dicho dispositivo.

El \textbf{difusor}, manda periodiamente al servidor, mediante una petición REST, los datos comprimidos de los pasos de los dispositivos.

% ------------------------------------------------------------------

\subsubsection{Lilith: Pasarela de red}

Dado que el sistema puede ser implantado en una arquitectura de red compleja, como puede ser la perteneciente a un organismo público, nos vemos en la problemática de comunicar los dispositivos con el servidor de forma que no suponga una vulnerabilidad en la red o en redes que no dispongan de salida a Internet (las de ámbito local).

Para ello se puede habilitar una Raspberry Pi con Horeb como sistema operativo, que haría uso del sistema \textit{Lilith} para hacer la transmisión del tráfico entre las otras Raspberry y el Servidor.

De esta forma Lilith sirve como pasarela entre las dos redes, la local y la red global que comunica al servidor.


% -------------------------------------------------------------

\subsubsection{Abdiel: Servidor de entrada de datos}
% Antonio - ¿de entrada o de almacenamiento?

Abdiel es el software que provee los servicios de la API REST de comunicación empleados por Raziel. Está desarrollado en PHP considerando especialmente la atomicidad de las operaciones.
% Antonio - para...

Entre otros servicios, proporciona la conexión y desconexión al sistema del software de captación, el sistema de privilegios, el servicio de actualización del software y la incorporación de pasos de dispositivos al sistema.
% Antonio - ¿'el almacenamiento' en lugar de 'la incorporación'?

Este servicio es el encargado de almacenar los datos de los pasos, por tanto, se encarga de descomprimirlos, procesarlos y mandarlos en lotes a la base de datos (Alejandría).

% -------------------------------------------------------------------

\subsubsection{Alejandría: Base de datos local}

Alejandría es la base de datos donde se almacena la información de los pasos capturada en los dispositivos. Está basada en MySQL haciendo uso de diversos mecanismos de optimización tales como particionado de tablas e índices, que permiten el acceso a la información en tiempo constante. Esta base de datos es privada y no es difundida.
% Antonio - ¿eso qué quiere decir?

Dispone de procedimientos optimizados para el cálculo del número total de pasos captados en ventanas temporales para los dispositivos de captación, así como para el cálculo de re-ocurrencia de dispositivos (detectados) en distintos nodos.

Estos procedimientos son invocados por el software \textit{Ezequiel} para recolectar los datos y publicarlos en la nube.

% -------------------------------------------------------

\subsubsection{Ezequiel: Publicación en la nube}

Ezequiel es el software encargado del acceso a la base datos, consulta y generación de resúmenes de datos, aplicación de algoritmos de predicción y minería de datos y difundisión los resultados en la nube \textit{Anan}.
% Antonio - esto habría que extenderlo un poco. Es un componente clave (desde nuestro punto de vista GeNeurino). Explicar un poco los algoritmos disponibles, su utilidad, etc... ;)

% --------------------------------------------------------

\subsubsection{Anan: La nube}

Anan es el nombre otorgado a la nube basada en la tecnología de Google en la que se almacenan los datos con el fin de darle difusión a los mismos. En Anan los datos son almacenados en tablas \textit{BigTable NoSQL} mediante la tecnología de Google Fusion Tables. Esta tecnología provee una base de datos geolocalizada (empleada en otras tecnologías de Google como Google Maps).

Anan se encarga también de proveer gráficas interactivas y mapas del estado histórico, actual y predicho de los distintos nodos.


% **********************************************************************

\section{Prototipo experimental}
\label{sec:prototipo}


% Antonio - Esto habrá que completarlo, ¿no? XD

% Antonio - no olvidarse de decir que esto está abierto (o lo de SIPESCA), al menos y poner la URL. ;)

% **********************************************************************

\section{Conclusiones y trabajo futuro}
\label{sec:conclusiones}

Actualmente existen distintas necesidades desde el punto de vista de gestión del transporte, como la necesidad de dispositivos de captación de datos y monitorización de bajo coste, autónomos y que permitan la detección unívoca de los usuarios para poder realizar decisiones sobre la gestión de la movilidad. Este trabajo describe un sistema hardware y software basado en nodos de captación de dispositivos Bluetooth y WiFi, que portan los agentes detectar (personas o vehículos). Esto permitirá su identificación de forma univoca y anónima (respetando la ley de privacidad). 

En el trabajo se ha descrito en detalle el hardware utilizado, Raspberry Pi Model A, así como los diferentes elementos software necesarios en el dispositivo de monitorización (sistema operativo, software de captación, pasarela de red) y en los servidores adicionales (servidor de entrada de datos y base de datos local). Además, se ha  comentado el servicio de publicación de datos en la nube que se usa en el sistema.

Como trabajo futuro se plantea mejorar el sistema utilizando el modelo más avanzado de Raspberry Pi (modelo 2), que permitirá, principlamente, mejorar el procesamiento del sistema (con paralelización en hebras) y añadir nuevos sensores de captación (GSM, luminosidad, temperatura, etc). 
Además, se planea diseñar y ofrecer distintos algoritmos de predicción, así como la combinación de los datos capturados con otras fuentes de datos abiertas.


\section*{Agradecimientos}
Este artículo ha sido financiado en parte por los proyectos
TIN2014-56494-C4-3-P (EphemeCH),
SIPESCA (Programa Operativo FEDER de Andalucía 2007-2013),
SPIP2014-01437 (Dirección General de Tráfico), 
PRY142/14 (Fundación Pública Andaluza Centro de Estudios Andaluces en la IX Convocatoria de Proyectos de Investigación) y el proyecto V17-2015 del programa de Microproyectos CEI BioTIC 2015 de Granada.


\bibliographystyle{Jornadas}
\bibliography{monitorizacion-jce}

\end{document}
